<!DOCTYPE html>
<html>
<head>
  <title>Interactive Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
  <div id="map" style="height: 800px;"></div>

  <script>
    // Initialize map
    var map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
      maxZoom: 18,
    }).addTo(map);

    var bounds = map.getBounds();
    var neLat = bounds._northEast.lat;
    var neLon = bounds._northEast.lng;

    var swLat = bounds._southWest.lat;
    var swLon = bounds._southWest.lng;

    var boundaries = {
      'ne_lat' : neLat,
      'ne_lon' : neLon,
      'sw_lat' : swLat,
      'sw_lon' : swLon,
      }
    console.log('initial bounds', boundaries)
    // Function to update markers
  
    function updateMarkers() {
  $.ajax({
    type: 'POST',
    url: '/markers',
    contentType: 'application/json',
    data: JSON.stringify(boundaries),
    success: function(data) {
      var markers = data.markers;
      map.eachLayer(function(layer) {
        if (layer instanceof L.Marker) {
          map.removeLayer(layer);
        }
      });
      if (markers.length > 0) {
        for (var i = 0; i < Math.min(markers.length, 10); i++) {
          var marker = markers[i];
          L.marker([marker.lat, marker.lon]).addTo(map).bindPopup(
                  "<b>" + marker.title + "</b><br>" + 
                  "Description: " + marker.short_description + "<br>" +
                  "Starts at: " + marker.start_at + "<br>" +
                  "Estimated duration: " + marker.estimated_duration_minutes + " minutes"
                  );
        }
      }
    },
    error: function(error) {
      console.log(error);
    }
  });
} 
  
    // Add markers initially
    updateMarkers();
    console.log('initial placement')

    // Update markers when map is moved or zoomed
    map.on('moveend', function() {
      bounds = map.getBounds();
      neLat = bounds._northEast.lat;
      neLon = bounds._northEast.lng;
      swLat = bounds._southWest.lat;
      swLon = bounds._southWest.lng;
       boundaries = {
      'ne_lat' : neLat,
      'ne_lon' : neLon,
      'sw_lat' : swLat,
      'sw_lon' : swLon,
      }
      console.log(boundaries)
      updateMarkers();
      console.log('map moved, markers updated')
    });
  </script>
</body>
</html>